<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/erin.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/monokai.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h1>Token Up</h1><p>
					<h2>Keeping Hands out of the Cookie Jar</h2><p>
					<h4>Erin Browning</h4>
				</section>
				<section>
					Slides are available at:<p>
					<a href="https://www.frowning.wtf/token-up">https://www.frowning.wtf/token-up</a>
				</section>
				<section>
					<h3>$whoami</h3>
					<section>
						Senior Security Engineer<p>
						<a href="mailto:erin@frowning.wtf">erin@frowning.wtf</a><p>
						<a href="https://www.twitter.com/efrowning">@efrowning</a><p>
					</section>
					<section>
						<img src="./media/latacora-logo.png" alt="latacora logo">
					</section>
					<section>
						<img src="./media/slack-logo.svg" alt="slack logo" height="80%">
					</section>
				</section>
				<section>
					<section>
						<h3>The Problem</h3>
					</section>
					<section> 
						I'm an attacker.<p>
						I want to take over accounts on your website.<p>
					</section>
					<section>
						Your site probably looks like this:<p>
						API: www.frowning.wtf/api<p>
						Frontend client: www.frowning.wtf<p>
						Mobile clients
					</section>
					<section>
						Your sessions probably look like one or more of these:<p>
						<ul>
							<li>JWTs</li>
							<li>Randomized session token</li>
							<li>API tokens</li>
						</ul>
					</section>
					<section>
						As you break your website out from a monolith to microservices, how do you store sessions/tokens between an API and your browser-based frontend client?
					</section>
					<section>
						Auth0's answer:<p>
						<img src="./media/auth0.png">
					</section>
					<section>
						Is storing your authentication token in local storage that bad?<p>
						Let's find out.
					</section>
				</section>
				<section>
					<h3>In this talk:</h3><p>
					<ul>
						<li>Common vulnerabilities that execute in a browser</li>
						<li>Modern application structures</li>
						<li>How to take advantage of browser-based protections</li>
					</ul>
				</section>
				<section>
					<section>
						Let's talk about two common attacks
					</section>
					<section>
						XSS
					</section>
					<section>
						What is XSS?<p>
						Cross site scripting
					</section>
					<section>
						Attacker created javascript is executed in the user's browser in the context of site the user visited<p>
						<small>More at: <a href="owasp.org/index.php/Cross-site_Scripting_(XSS)">owasp.org/index.php/Cross-site_Scripting_(XSS)</a></small>
					</section>
					<section>
						How?<p>
						Injection!
					</section>
					<section>
						Cannonical testing example:
						<img src="./media/xss.png" alt="using alert in js plus an xss vulnerability">
					</section>
					<section>
						What can you do with XSS?<p>
						<ul>
							<li>Steal cookies</li>
							<li>Change passwords</li>
							<li>Take actions as the user</li>
							<li>Change page content</li>
						</ul>
					</section>
					<section>
						CSRF
					</section>
					<section>
						What is CSRF?<p>
						Cross-Site Request Forgery
						<small>More at: <a href="https://www.owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)">owasp.org/index.php/Cross-Site_Request_Forgery_(CSRF)</a></small>
					</section>
					<section>
						Forces a user to perform actions they didn't intend on a website to which they're authenticated 
					</section>
					<section>
						#FIXME need a diagram
						How? <p>
						Cookies are sent by default with requests sent cross domain.<p>
						<ul>
							<li>frowning.wtf sends a request to transfer money to bank.example when a user visits it</li>
							<li>the user is logged into bank.example
							<li>bank.example has no CSRF protection</li>
						</ul><p>
						<h4>money is transferred</h4>
					</section>
					<section>
						What do these attacks have in common?
					</section>
					<section>
						All of these attacks execute in the user's browser
					</section>
					<section>
						How are these attacks different?
					</section>
					<section>
						XSS > CSRF
					</section>
					<section>
						<img src="./media/anything.jpg" alt="cow + dolphin jumping up in an ocean with the caption 'anything you can do i can do better'" height="150%">
					</section>
				</section>
				<section>
					<section>
						How can we reduce the impact of these attacks?
					</section>
					<section>
						<h2>Architecture</h2>
					</section>
				</section>
				<section>
					<section>
						First, let's talk about a typical application structure:
						<ul>
							<li>www.domain.example - contains your frontend + any monolith code</li>
							<li>www.domain.example/api - api</li>
							<li>www.domain.example/admin - administrator site</li>
						</ul>
					</section>
					<section>
						#FIXME add frankenstein image
					</section>
					<section>
						Where is your authentication stored in the browser?
					</section>
					<section>
						Probably in a cookie<p>
						That cookie is probably scoped to *.domain.example<p>
						If not, it'll be in local storage, placed there by your javascript<p>
					</section>
					<section>
						Interactions are going through XHR to /api<p>
					</section>
					<section>
						How do you even do CSRF protection to your API? 
					</section>
					<section>
						Depends on ~content types~<p>
						<ul>
							<li>*/*</li>
							<li>text/plain</li>
							<li>application/x-www-url-form-encoded</li>
							<li>application/json</li>
						</ul>
					</section>
					<section>
						<ul>
							<li>*/*, can go cross origin</li> 
							<li>text/plain, can go cross origin</li>
							<li>application/x-www-url-form-encoded, can go cross origin</li>
							<li>application/json, can't go cross origin without CORS</li>
						</ul>
					</section>
					<section>
						What is CORS?
					</section>
					<section>
						CORS is Cross Origin Resource Sharing.<p>
						Lots of requests can't be made from URL1 to URL2 if they differ on the following things:
						<ul>
							<li>Protocol (e.g., HTTP vs HTTPS)</li>
							<li>Port</li>
							<li>Host</li>
						</ul><p>
						https://www.example.invalid:80<p>
						It has to be set on the assets you are accessing.
					</section>
				</section>
				<section>
					<section>
						Improvement: use subdomains
					</section>
					<section>
						Now you have: <p>
							<ul>
								<li>api.frowning.wtf</li>
								<li>www.frowning.wtf</li>
								<li>admin.frowning.wtf</li>
							</ul>
					</section>
					<section>
						You can scope cookies to www, admin and api instead of using *.<p>
						The API cookie can have the secure and HTTPonly flags set.<br>
						<small>Secure means that cookie will only be sent over HTTPS</small><br>
						<small>HTTPonly means js can't touch it</small><br>
						<small>Yes, the names are confusing</small>
					</section>
					<section>
						You XHR your requests to api from www.
					</section>
					<section>
						How do you prevent CSRF?<p>
						Content-types: set up CORS and only allow application/json.
					</section>
					<section>
						How do you reduce the impact of XSS?<p>
						API isn't running js.<p>
						www could still be vulnerable, and site could send requests through XHR.
					</section>
				</section>
				<section>
					<section>
						Third way: static pages
					</section>
					<section>
						The auth token lives in a completely static page
					</section>
					<section>
						OAuth does this (specifically OpenID Connect)<p>
						The redirect uses api.example.invalid instead of www.example.invalid<p>
						API won't serve html or js; this keeps tokens out of anything scraping doc.location() on www.
					</section>
					<section>
						get an example
					</section>
				</section>
				<section>
					<section>
						Fourth way: iFrames
					</section>
					<section>
						Instead of using CORS, create an iFrame on www to api.<p>
						Use the window.postMessage API<p>
						<small>docs at <a href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage">developer.mozilla.org/en-US/docs/Web/API/Window/postMessage</a></small>
					</section>
					<section>
						window.postMessage() enables cross-origin communication through the event object
					</section>
					<section>
						#FIXME make a diagram
					</section>
					<section>
						#FIXME talk about targetOrigin *
					</section>
				</section>
				<section>
					<section>
						Fifth way: websockets
					</section>
					<section>
						Verify your `Origin` header.
					</section>
					<section>
						The attacker would need to fake the origin header in the victim's browser.<p>
						Modern browsers don't let you set your own origin header.
					</section>
					<section>
						The protocol upgrade request will have access to the browser's cookies. Check the auth when upgrading.
					</section>
				</section>
				<section>
					<section>
						Similarities<p>
						Static pages, iFrames and websockets all have trustworthy origins in the browser.
					</section>
					<section>
						Ultimately, how can you avoid CSRF hitting your API?<p>
						By dropping all requests to API that aren't application/json
					</section>
					<section>
						How can you avoid XSS?<p>
						You can't completely.
					</section>
					<section>
						How do you know you have a good understanding of all this?<p>
						Tell me why XSS is worse in all these cases.
					</section>
				</section>
				<section>
					<h3>Special Thanks</h3>
					<section>
						lvh @latacora<p>
						Leigh Honeywell @tallpoppy<p>
						The latacora team<p>
						The Product Security teams @Slack<p>
					</section>
				</section>
				<section>
					see you on the internet bb
				</section>
			</div>
		</div>

		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true }
				]
			});
		</script>
	</body>
</html>
